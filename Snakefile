import os
from pathlib import Path

configfile: "config.yaml"


def read_accessions(path: str) -> list[str]:
    with open(path) as f:
        return [l.strip() for l in f if l.strip() and not l.startswith("#")]


# ------------------------------------------------------------------
# Inputs: ONLY config.yaml + accessions.txt are required on a clean clone
# ------------------------------------------------------------------
ACCESSIONS = read_accessions(config["accessions_file"])
SAMPLES = ACCESSIONS  # sample IDs == run accessions in this project


# ------------------------------------------------------------------
# FASTQs and samples table (generated by scripts/download_fastq.sh)
# ------------------------------------------------------------------
FASTQ_R1 = expand(
    "{fastq_dir}/{sample}_1.fastq.gz",
    fastq_dir=config["fastq_dir"],
    sample=SAMPLES,
)
FASTQ_R2 = expand(
    "{fastq_dir}/{sample}_2.fastq.gz",
    fastq_dir=config["fastq_dir"],
    sample=SAMPLES,
)


# ------------------------------------------------------------------
# Reference (raw + canonical)
# ------------------------------------------------------------------
REF_DIR = config["reference_dir"]
REF_FILE = config["references"][0].replace(".gz", "")
CANON_FILE = config["reference_canonical"][0]

REF_FA = os.path.join(REF_DIR, REF_FILE)
CANON_FA = os.path.join(REF_DIR, CANON_FILE)

REF_FAIDX = [REF_FA + ".fai", CANON_FA + ".fai"]
REF_DICT = [os.path.splitext(REF_FA)[0] + ".dict", os.path.splitext(CANON_FA)[0] + ".dict"]

BWA_INDEX = [CANON_FA + ext for ext in [".amb", ".ann", ".bwt", ".pac", ".sa"]]


# ------------------------------------------------------------------
# BAM outputs
# ------------------------------------------------------------------
BAM_DIR = config["bam_dir"]
Path(BAM_DIR).mkdir(parents=True, exist_ok=True)

SAMS = expand(os.path.join(BAM_DIR, "{sample}.sam"), sample=SAMPLES)
SORTED_BAMS = expand(os.path.join(BAM_DIR, "{sample}.sorted.bam"), sample=SAMPLES)


# ------------------------------------------------------------------
# Metrics outputs
# ------------------------------------------------------------------
METRICS_DIR = config["metrics_dir"]
Path(METRICS_DIR).mkdir(parents=True, exist_ok=True)

METRICS = expand(os.path.join(METRICS_DIR, "{sample}.alignment_metrics.txt"), sample=SAMPLES)


# ------------------------------------------------------------------
# Dedup + index outputs
# ------------------------------------------------------------------
DEDUP_DIR = config["dedup_dir"]
Path(DEDUP_DIR).mkdir(parents=True, exist_ok=True)

DEDUP_BAMS = expand(os.path.join(DEDUP_DIR, "{sample}.dedup.bam"), sample=SAMPLES)
DEDUP_METRICS = expand(os.path.join(DEDUP_DIR, "{sample}.metrics.txt"), sample=SAMPLES)
DEDUP_BAI = expand(os.path.join(DEDUP_DIR, "{sample}.dedup.bai"), sample=SAMPLES)


# ------------------------------------------------------------------
# Step 4 — Call Variants (GATK4 HaplotypeCaller)
# ------------------------------------------------------------------
VCF_DIR = config["vcf_dir"]
Path(VCF_DIR).mkdir(parents=True, exist_ok=True)

RAW_VCFS = expand(os.path.join(VCF_DIR, "{sample}.raw_variants.vcf"), sample=SAMPLES)
RAW_VCF_IDXS = [v + ".idx" for v in RAW_VCFS]


# ------------------------------------------------------------------
# Step 5 — Split Variants (SNP vs INDEL)
# ------------------------------------------------------------------
RAW_SNP_VCFS = expand(os.path.join(VCF_DIR, "{sample}.raw_snps.vcf"), sample=SAMPLES)
RAW_SNP_VCF_IDXS = [v + ".idx" for v in RAW_SNP_VCFS]

RAW_INDEL_VCFS = expand(os.path.join(VCF_DIR, "{sample}.raw_indels.vcf"), sample=SAMPLES)
RAW_INDEL_VCF_IDXS = [v + ".idx" for v in RAW_INDEL_VCFS]


# ------------------------------------------------------------------
# Step 6 — Filter SNPs
# ------------------------------------------------------------------
FILTERED_SNP_VCFS = expand(os.path.join(VCF_DIR, "{sample}.filtered_snps.vcf"), sample=SAMPLES)
FILTERED_SNP_VCF_IDXS = [v + ".idx" for v in FILTERED_SNP_VCFS]


# ------------------------------------------------------------------
# Step 7 — Filter INDELs
# ------------------------------------------------------------------
FILTERED_INDEL_VCFS = expand(os.path.join(VCF_DIR, "{sample}.filtered_indels.vcf"), sample=SAMPLES)
FILTERED_INDEL_VCF_IDXS = [v + ".idx" for v in FILTERED_INDEL_VCFS]


# ------------------------------------------------------------------
# Step 8 — Exclude Filtered Variants (PASS-only for BQSR)
# ------------------------------------------------------------------
BQSR_SNP_VCFS = expand(os.path.join(VCF_DIR, "{sample}.bqsr_snps.vcf"), sample=SAMPLES)
BQSR_SNP_VCF_IDXS = [v + ".idx" for v in BQSR_SNP_VCFS]

BQSR_INDEL_VCFS = expand(os.path.join(VCF_DIR, "{sample}.bqsr_indels.vcf"), sample=SAMPLES)
BQSR_INDEL_VCF_IDXS = [v + ".idx" for v in BQSR_INDEL_VCFS]


# ------------------------------------------------------------------
# Step 9 — BQSR #1
# Step 10 — Apply BQSR
# Step 11 — BQSR #2 (optional)
# Step 12 — AnalyzeCovariates (optional; requires Step 11)
# ------------------------------------------------------------------
BQSR_DIR = config["bqsr_dir"]
Path(BQSR_DIR).mkdir(parents=True, exist_ok=True)

BQSR_TABLES = expand(os.path.join(BQSR_DIR, "{sample}.recal_data.table"), sample=SAMPLES)
RECAL_BAMS = expand(os.path.join(BQSR_DIR, "{sample}.recal_reads.bam"), sample=SAMPLES)
POST_BQSR_TABLES = expand(os.path.join(BQSR_DIR, "{sample}.post_recal_data.table"), sample=SAMPLES)

RECAL_PLOTS_PDF = expand(os.path.join(BQSR_DIR, "{sample}.recalibration_plots.pdf"), sample=SAMPLES)
RECAL_PLOTS_CSV = expand(os.path.join(BQSR_DIR, "{sample}.recalibration_plots.csv"), sample=SAMPLES)

ENABLE_BQSR_SECOND_PASS = bool(config.get("bqsr_second_pass", False))


# ------------------------------------------------------------------
# Step 13 — Call Variants again (analysis-ready BAM)
# ------------------------------------------------------------------
RAW_RECAL_VCFS = expand(
    os.path.join(VCF_DIR, "{sample}.raw_variants_recal.vcf"),
    sample=SAMPLES,
)
RAW_RECAL_VCF_IDXS = [v + ".idx" for v in RAW_RECAL_VCFS]

RECAL_BAMS = expand(
    os.path.join(config["bqsr_dir"], "{sample}.recal_reads.bam"),
    sample=SAMPLES,
)
RECAL_BAIS = expand(
    os.path.join(config["bqsr_dir"], "{sample}.recal_reads.bai"),
    sample=SAMPLES,
)


# ------------------------------------------------------------------
# Step 14 — Extract SNPs & Indels (post-BQSR)
# ------------------------------------------------------------------
RAW_SNPS_RECAL = expand(
    os.path.join(VCF_DIR, "{sample}.raw_snps_recal.vcf"),
    sample=SAMPLES,
)
RAW_INDELS_RECAL = expand(
    os.path.join(VCF_DIR, "{sample}.raw_indels_recal.vcf"),
    sample=SAMPLES,
)
RAW_SNPS_RECAL_IDXS = [v + ".idx" for v in RAW_SNPS_RECAL]
RAW_INDELS_RECAL_IDXS = [v + ".idx" for v in RAW_INDELS_RECAL]


# ------------------------------------------------------------------
# Step 15 — Filter SNPs (FINAL; post-BQSR)
# ------------------------------------------------------------------
FILTERED_SNPS_FINAL = expand(
    os.path.join(VCF_DIR, "{sample}.filtered_snps_final.vcf"),
    sample=SAMPLES,
)
FILTERED_SNPS_FINAL_IDXS = [v + ".idx" for v in FILTERED_SNPS_FINAL]


# ------------------------------------------------------------------
# Step 16 — Filter Indels (FINAL; post-BQSR)
# ------------------------------------------------------------------
FILTERED_INDELS_FINAL = expand(
    os.path.join(VCF_DIR, "{sample}.filtered_indels_final.vcf"),
    sample=SAMPLES,
)
FILTERED_INDELS_FINAL_IDXS = [v + ".idx" for v in FILTERED_INDELS_FINAL]


# ------------------------------------------------------------------
# Step 17 — Annotate SNPs and Predict Effects (SnpEff)
# ------------------------------------------------------------------
ANNOTATED_SNPS_FINAL = expand(
    os.path.join(VCF_DIR, "{sample}.filtered_snps_final.ann.vcf"),
    sample=SAMPLES,
)
SNPEFF_SUMMARY_HTML = expand(
    os.path.join(VCF_DIR, "{sample}.snpeff_summary.html"),
    sample=SAMPLES,
)
SNPEFF_GENES_TXT = expand(
    os.path.join(VCF_DIR, "{sample}.snpEff_genes.txt"),
    sample=SAMPLES,
)


# ------------------------------------------------------------------
# Step 18 — Compile Statistics (CSV report)
# ------------------------------------------------------------------
REPORT_DIR = config.get("report_dir", "results/reports")
Path(REPORT_DIR).mkdir(parents=True, exist_ok=True)

SAMPLE_REPORTS = expand(
    os.path.join(REPORT_DIR, "{sample}.report.csv"),
    sample=SAMPLES,
)
COMBINED_REPORT = os.path.join(REPORT_DIR, "report.csv")


# ------------------------------------------------------------------
# Include rules
# ------------------------------------------------------------------
include: "rules/download_fastq.smk"
include: "rules/reference.smk"
include: "rules/align.smk"
include: "rules/sort_bam.smk"
include: "rules/metrics.smk"
include: "rules/mark_duplicates.smk"
include: "rules/index_bam.smk"
include: "rules/haplotypecaller.smk"
include: "rules/select_variants.smk"
include: "rules/filter_snps.smk"
include: "rules/filter_indels.smk"
include: "rules/exclude_filtered_variants.smk"
include: "rules/bqsr.smk"
include: "rules/analyze_covariates.smk"
include: "rules/haplotypecaller_recal.smk"
include: "rules/select_variants_recal.smk"
include: "rules/filter_snps_final.smk"
include: "rules/filter_indels_final.smk"
include: "rules/snpeff_annotate.smk"
include: "rules/compile_report.smk"


rule all:
    input:
        config["samples_tsv"],
        FASTQ_R1,
        FASTQ_R2,
        REF_FA,
        CANON_FA,
        REF_FAIDX,
        REF_DICT,
        BWA_INDEX,
        SORTED_BAMS,
        METRICS,
        DEDUP_BAMS,
        DEDUP_METRICS,
        DEDUP_BAI,
        RAW_VCFS,
        RAW_VCF_IDXS,
        RAW_SNP_VCFS,
        RAW_SNP_VCF_IDXS,
        RAW_INDEL_VCFS,
        RAW_INDEL_VCF_IDXS,
        FILTERED_SNP_VCFS,
        FILTERED_SNP_VCF_IDXS,
        FILTERED_INDEL_VCFS,
        FILTERED_INDEL_VCF_IDXS,
        BQSR_SNP_VCFS,
        BQSR_SNP_VCF_IDXS,
        BQSR_INDEL_VCFS,
        BQSR_INDEL_VCF_IDXS,
        BQSR_TABLES,
        RECAL_BAMS,
        (POST_BQSR_TABLES if ENABLE_BQSR_SECOND_PASS else []),
        (RECAL_PLOTS_PDF if ENABLE_BQSR_SECOND_PASS else []),
        (RECAL_PLOTS_CSV if ENABLE_BQSR_SECOND_PASS else []),
        RECAL_BAMS,
        RECAL_BAIS,
        RAW_RECAL_VCFS,
        RAW_RECAL_VCF_IDXS,
        RAW_SNPS_RECAL,
        RAW_SNPS_RECAL_IDXS,
        RAW_INDELS_RECAL,
        RAW_INDELS_RECAL_IDXS,
        FILTERED_SNPS_FINAL,
        FILTERED_SNPS_FINAL_IDXS,
        FILTERED_INDELS_FINAL,
        FILTERED_INDELS_FINAL_IDXS,
        ANNOTATED_SNPS_FINAL,
        SNPEFF_SUMMARY_HTML,
        SNPEFF_GENES_TXT,
        SAMPLE_REPORTS,
        COMBINED_REPORT